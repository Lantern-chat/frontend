@use "sass:math";

@import "lib/math.scss";

@function kelvin($temp) {
    $temp: $temp * 0.01;

    $red: 0;
    $green: 0;
    $blue: 0;

    @if $temp <= 66 {
        $red: 255;
        $green: 99.4708025861 * math-ln($temp) - 161.1195681661;

        @if $temp > 19 {
            $blue: 138.5177312231 * math-ln($temp - 10) - 305.0447927307;
        }
    } @else {
        $red: 329.698727446 * math-pow-polyfill($temp - 60, -0.1332047592);
        $green: 288.1221695283 * math-pow-polyfill($temp - 60, -0.0755148492);
        $blue: 255;
    }

    @return rgb($red, $green, $blue);
}

$BLACKBODY_TABLE_R: (
    (2.52432244e3, -1.06185848e-3, 3.11067539),
    (3.37763626e3, -4.34581697e-4, 1.64843306),
    (4.10671449e3, -8.61949938e-5, 6.41423749e-1),
    (4.668498e3, 2.85655028e-5, 1.29075375e-1),
    (4.6012477e3, 2.89727618e-5, 1.48001316e-1),
    (3.78765709e3, 9.36026367e-6, 3.98995841e-1)
);

$BLACKBODY_TABLE_G: (
    (-7.50343014e2, 3.15679613e-4, 4.73464526e-1),
    (-1.00402363e3, 1.29189794e-4, 9.08181524e-1),
    (-1.22075471e3, 2.56245413e-5, 1.20753416),
    (-1.42546105e3, -4.01730887e-5, 1.44002695),
    (-1.18134453e3, -2.18913373e-5, 1.30656109),
    (-5.00279505e2, -4.5974539e-6, 1.09090465)
);

$BLACKBODY_TABLE_B: (
    (0, 0, 0, 0),
    (0, 0, 0, 0),
    (0, 0, 0, 0),
    (-2.02524603e-11, 1.7943586e-7, -2.60561875e-4, -1.41761141e-2),
    (-2.22463426e-13, -1.55078698e-8, 3.8167516e-4, -7.30646033e-1),
    (6.72595954e-13, -2.73059993e-8, 4.24068546e-4, -7.52204323e-1)
);

@function kelvin2($t) {
    $r: 0;
    $g: 0;
    $b: 0;

    @if $t >= 12000 {
        $r: 0.826270103;
        $g: 0.994478524;
        $b: 1.56626022;
    } @else if $t < 965 {
        $r: 4.70366907;
    } @else {
        $i: 5;

        @if $t < 6365 {
            $i: 4;
            @if $t < 3315 {
                $i: 3;
                @if $t < 1902 {
                    $i: 2;
                    @if $t < 1449 {
                        $i: 1;
                        @if $t < 1167 {
                            $i: 0;
                        }
                    }
                }
            }
        }

        $i: $i + 1;

        $r: nth($BLACKBODY_TABLE_R, $i);
        $g: nth($BLACKBODY_TABLE_G, $i);
        $b: nth($BLACKBODY_TABLE_B, $i);

        $t_inv: math.div(1, $t);

        $r: nth($r, 1) * $t_inv + nth($r, 2) * $t + nth($r, 3);
        $g: nth($g, 1) * $t_inv + nth($g, 2) * $t + nth($g, 3);
        $b: ((nth($b, 1) * $t + nth($b, 2)) * $t + nth($b, 3)) * $t + nth($b, 4);
    }

    $v: max(max($r, $g), $b);

    $iv: math.div(255, $v);
    @if $v == 0 {
        $iv: 0;
    }

    @return rgb($r * $iv, $g * $iv, $b * $iv);
}
